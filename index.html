<!doctype html>
<html>
	<head>
		<script src="http://42nd.org:8090/socket.io/socket.io.js"></script>
		<script src="util.js"></script>
		<script src="vector.js"></script>
		<script src="entity.js"></script>
		<script src="color.js"></script>
		<script src="ball.js"></script>
		<script src="world.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<style>
			html, body {background: #202020; width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden}
			#message {background: #c0c0c0; font-size: 20px; color: #202020; font-family: sans-serif; }
		</style>

		<title>Test</title>
	</head>
	<body>
		<div id="message"></div>
		<canvas id="canvas" height="800" width="1000" style="margin: auto; display: block;">Wat</canvas>
		<script>
			window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame  || window.oRequestAnimationFrame || function(callback) {
					window.setTimeout(function() {callback(Date.now())}, 1000 / 60.0);
				};


			//Get canvas stuff
			var canvas = $('#canvas').get(0);
			var width = canvas.width, height = canvas.height;

			// $(window).resize(function(){
			// 	width = canvas.width = $(canvas).width();
			// 	height = canvas.height = $(canvas).height();
			// }).resize();

			var ctx = canvas.getContext('2d');
			var ball;
			var opponents = {};

			var keycodes = {
				up:    87,
				down:  83,
				left:  65,
				right: 68
			};

			var universe = new World(1000, 800);

			

			var socket = io.connect('http://42nd.org:8090');
			var name;
			(function joinTheGame(i) {
				var n = 'bot' + i;
				socket.emit('join', n, function(data) {
					if(data) {
						name = n;
						startPlaying();
					} else {
						joinTheGame(i + 1);
					}
				});
			})(0);

			socket.on('entityadded', function (data) {
				var b = new Ball(
					Vector.ify(data.p),
					data.r,
					Color.ify(data.c)
				);
				b._id = data.i; //probably going to regret this
				universe.addEntity(b);
			});
			socket.on('entitylost', function (id) {
				delete universe.entities[id];
			});
			socket.on('servermessage', function (str) {
				$('#message').text(str);
			});
			function startPlaying() {
				socket.on('entityupdates', function (data) {
					for(id in data) {
						if(id in universe.entities) {
							var edata = data[id];
							var p = Vector.ify(edata.pos);
							var c = Color.ify(edata.color);
							var e = universe.entities[id];
							if(p) e.position = p;
							e.color = c;
							e.radius = edata.radius;
							e.name = edata.playername;
							e.head = edata.head;
						} else {
							//console.log("Id "+id+" not found!");
						}
					}
					
					var me = universe.entityById(id);
					var dist = -1;
					var closest;
					var mass = 0;
					for(e in universe.entities) {
						if(e.name == me.name) {
							mass += e.mass;
						}
					}
					for(e in universe.entities) {
						if(!e.position) console.log(e.position);
						if(e.name == me.name || e.mass > mass * 2) continue;
						
						var d = Math.sqrt(Math.pow(e.position.x - me.position.x, 2) + Math.pow(e.position.y - me.position.y, 2));
						if(dist == -1 || d < dist) {
							dist = d;
							closest = e;
						}
					}
					if(closest) {
						socket.emit('playercontrol', new Vector2(closest.position.x, closest.position.y));
					}
					/*else {
						socket.emit('playercontrol', me.position);
					}*/
				});

				var target = new Vector();
				/*$(document).mousemove(function(e) {
					var offset = $(canvas).offset();
					var x = e.pageX - offset.left;
					var y = e.pageY - offset.top;
					target.set(x, y);
					socket.emit('playercontrol', target);
				});*/

				var lastt = Date.now();
				function draw(t) {
					//Calculate frame time
					var dt = (t - lastt) / 1000.0;

					ctx.globalCompositeOperation = "source-over";
					ctx.fillStyle = "black";
					ctx.fillRect(0, 0, width, height);

					universe.entities.forEach(function(e) {
						e.drawTo(ctx);
						ctx.fillStyle = "white";
						if(e.head) ctx.fillText(e.name, e.position.x, e.position.y);
					});

					//prepare for next frame
					lastt = t;
					requestAnimationFrame(draw);
				}
				requestAnimationFrame(draw);
			}
		</script>
	</body>
</html>